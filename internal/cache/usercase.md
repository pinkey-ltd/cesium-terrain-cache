## 用户的请求特征

用户请求通常具有以下特征：

1. 高并发性：
   - 在地图应用中，用户可能同时请求多个瓦片（例如平移或缩放时）。
   - 请求量与用户数量和地图操作频率成正比。
2. 局部性：
   - 空间局部性：用户通常浏览相邻区域，请求的瓦片在地理位置上集中。
   - 时间局部性：同一区域的瓦片可能在短时间内被多次请求（例如反复缩放或返回之前浏览的区域）。
3. 静态性：
   - 瓦片通常是静态的（预渲染或缓存后不频繁变化），不像要素那样动态生成。
   - 数据更新频率低（例如每周、每月或更长），缓存的瓦片可以长时间有效。

## 缓存机制的实现

为了高效缓存，需要设计一个适合上述请求特征的缓存机制。以下是推荐的缓存机制及其实现要点：

- 内存缓存：
  - 使用内存（如 `Redis`、`Memcached`）存储热点瓦片，适合高频访问的瓦片。
  - 优点：读取速度快，延迟低。
  - 缺点：内存有限，无法存储所有瓦片，需配合持久化缓存。
- 磁盘缓存：
  - 将瓦片存储在文件系统或数据库中，适合长期存储。
  - 优点：容量大，可存储所有预渲染瓦片。
  - 缺点：读取速度慢于内存。
- 混合缓存：
  - 结合内存和磁盘，例如热点瓦片存内存，冷数据存磁盘。

### 根据用户请求特征，推荐以下策略：

- 空间优先：

  - 优先缓存用户当前视口附近瓦片，利用空间局部性。
  - 实现：预加载周围瓦片（例如基于当前 `TileRow/TileCol ±N`）。

  

### 以下是推荐的缓存机制：

- 分层缓存（Tiered Caching）：

  - 第一层（内存缓存）：使用 `Redis` 存储热点瓦片（例如最近 1 小时访问的瓦片），容量限制为内存的 20%-30%。
  - 第二层（`sqlite`缓存）：

  ```go
  CREATE TABLE tiles (
      key TEXT PRIMARY KEY,    -- 瓦片键（如 "example:EPSG:4326:5:10:15"）
      data BLOB,              -- 瓦片数据（PNG/JPEG 二进制）
      created_at INTEGER,     -- 创建时间戳（用于清理）
      last_accessed INTEGER   -- 最后访问时间戳（用于 LRU）
  );
  ```

  - 第三层（磁盘缓存）：使用文件系统存储所有瓦片，按目录结构组织（如 `{tileset}/{z}/{x}/{y}.terrain`）。
  - 工作流程：
    1. 接收用户请求，检查内存缓存。
    2. 若未命中，检查磁盘缓存。
    3. 若仍未命中，生成瓦片（或从源服务器获取），存入磁盘和内存。

### 性能对比

- 内存缓存（如 `Redis`）：微秒级延迟，适合热点数据。
- `SQLite`：毫秒级延迟，适合中频访问的持久化数据。
- 文件系统：毫秒到十毫秒级延迟，依赖文件数量和磁盘性能。
